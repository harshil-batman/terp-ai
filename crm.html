<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Acquisition CRM | Steel Trading</title>
  <style>
    :root {
      --bg: #f8fafc;
      --surface: #ffffff;
      --border: #e2e8f0;
      --text: #1e293b;
      --text-muted: #64748b;
      --primary: #0f766e;
      --primary-hover: #0d9488;
      --accent: #0891b2;
      --success: #059669;
      --warning: #d97706;
      --danger: #dc2626;
      --info: #0284c7;
      --sidebar-bg: #0f172a;
      --sidebar-text: #e2e8f0;
      --sidebar-active: #0f766e;
      --radius: 8px;
      --shadow: 0 1px 3px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.08);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; line-height: 1.5; }

    .app { display: flex; min-height: 100vh; }

    /* Sidebar */
    .sidebar {
      width: 240px;
      background: var(--sidebar-bg);
      color: var(--sidebar-text);
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
    }
    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      font-weight: 600;
      font-size: 1rem;
    }
    .sidebar-nav { flex: 1; padding: 12px 0; overflow-y: auto; }
    .sidebar-nav a {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 20px;
      color: var(--sidebar-text);
      text-decoration: none;
      font-size: 0.9rem;
      transition: background 0.15s, color 0.15s;
    }
    .sidebar-nav a:hover { background: rgba(255,255,255,0.06); }
    .sidebar-nav a.active { background: var(--sidebar-active); color: #fff; }
    .sidebar-nav .icon { width: 20px; text-align: center; opacity: 0.9; }

    /* Main */
    .main { flex: 1; overflow-y: auto; padding: 24px; }

    .page { display: none; }
    .page.active { display: block; }

    .page-header { margin-bottom: 24px; }
    .page-header h1 { font-size: 1.5rem; font-weight: 600; color: var(--text); }

    /* Cards */
    .card {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      padding: 20px;
      margin-bottom: 20px;
    }
    .card-title { font-size: 0.95rem; font-weight: 600; margin-bottom: 16px; color: var(--text); }

    /* KPI Grid */
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .kpi-card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 18px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }
    .kpi-card .label { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.02em; margin-bottom: 4px; }
    .kpi-card .value { font-size: 1.5rem; font-weight: 700; color: var(--text); }

    /* Funnel */
    .funnel-section { margin-bottom: 28px; }
    .funnel-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    .funnel-bar .stage { font-size: 0.85rem; color: var(--text-muted); min-width: 100px; }
    .funnel-bar .bar-wrap { flex: 1; height: 28px; background: var(--border); border-radius: 6px; overflow: hidden; }
    .funnel-bar .bar-fill { height: 100%; border-radius: 6px; transition: width 0.3s; }
    .funnel-bar .count { font-size: 0.85rem; font-weight: 600; min-width: 36px; text-align: right; }

    /* AI Agents Control Center */
    .ai-agents-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 16px; color: var(--text); }
    .ai-agents-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
    @media (max-width: 900px) { .ai-agents-grid { grid-template-columns: 1fr; } }
    .agent-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
    }
    .agent-card .agent-name { font-weight: 600; margin-bottom: 6px; color: var(--text); }
    .agent-card .agent-desc { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 12px; line-height: 1.4; }
    .agent-card .agent-meta { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; margin-bottom: 12px; }
    .status-badge {
      font-size: 0.75rem;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 20px;
      text-transform: uppercase;
    }
    .status-badge.active { background: #d1fae5; color: var(--success); }
    .status-badge.inactive { background: #fef3c7; color: var(--warning); }
    .status-badge.paused { background: #fee2e2; color: var(--danger); }
    .status-badge.running { background: #cffafe; color: var(--info); }
    .toggle-wrap { display: flex; align-items: center; gap: 8px; }
    .toggle {
      width: 44px;
      height: 24px;
      background: var(--border);
      border-radius: 12px;
      cursor: pointer;
      position: relative;
      transition: background 0.2s;
    }
    .toggle.on { background: var(--primary); }
    .toggle::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      background: #fff;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: transform 0.2s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    .toggle.on::after { transform: translateX(20px); }
    .agent-activity {
      font-size: 0.8rem;
      color: var(--text-muted);
      padding-top: 12px;
      border-top: 1px solid var(--border);
      margin-top: 12px;
    }
    .agent-activity.disabled { opacity: 0.5; pointer-events: none; }
    .agent-activity .activity-item { margin-bottom: 4px; }

    /* Tables */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th, td { padding: 12px 14px; text-align: left; border-bottom: 1px solid var(--border); }
    th { font-weight: 600; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.02em; background: var(--bg); }
    tr:hover { background: #f8fafc; }
    .tag {
      display: inline-block;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 6px;
    }
    .tag-new { background: #dbeafe; color: #1d4ed8; }
    .tag-evaluating { background: #fef3c7; color: #b45309; }
    .tag-matched { background: #e0e7ff; color: #4338ca; }
    .tag-followup { background: #cffafe; color: #0369a1; }
    .tag-converted { background: #d1fae5; color: #047857; }
    .tag-closed { background: #f1f5f9; color: #475569; }
    .btn-link { color: var(--primary); cursor: pointer; text-decoration: none; font-weight: 500; }
    .btn-link:hover { text-decoration: underline; }

    /* Filters */
    .filters { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px; align-items: center; }
    .filters select, .filters input {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.9rem;
      background: var(--surface);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 18px;
      border-radius: var(--radius);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: background 0.2s, color 0.2s;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-secondary { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--bg); }
    .btn-success { background: var(--success); color: #fff; }
    .btn-success:hover { background: #047857; }

    /* Forms */
    .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
    @media (max-width: 640px) { .form-grid { grid-template-columns: 1fr; } }
    .form-group { margin-bottom: 16px; }
    .form-group.full { grid-column: 1 / -1; }
    .form-group label { display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 6px; color: var(--text); }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.9rem;
      background: var(--surface);
    }
    .form-group input.error, .form-group textarea.error { border-color: var(--danger); }
    .form-group .error-msg { font-size: 0.8rem; color: var(--danger); margin-top: 4px; }
    .form-group .ai-prompt {
      font-size: 0.8rem;
      color: var(--info);
      margin-top: 6px;
      padding: 8px 10px;
      background: #e0f2fe;
      border-radius: var(--radius);
      border-left: 3px solid var(--info);
    }

    /* Workflow / Timeline */
    .workflow-steps { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
    .workflow-step {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--bg);
      border-radius: var(--radius);
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    .workflow-step.done { background: #d1fae5; color: var(--success); }
    .workflow-step.current { background: #e0f2fe; color: var(--info); font-weight: 500; }
    .workflow-step .dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
    .timeline { position: relative; padding-left: 24px; border-left: 2px solid var(--border); margin-left: 8px; }
    .timeline-item { margin-bottom: 20px; position: relative; }
    .timeline-item::before {
      content: '';
      position: absolute;
      left: -30px;
      top: 6px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--primary);
    }
    .timeline-item .date { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px; }
    .timeline-item .content { font-size: 0.9rem; }

    /* Lead Detail */
    .lead-detail-header { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px; margin-bottom: 24px; }
    .lead-detail-header h1 { font-size: 1.35rem; }
    .convert-section { margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border); }
    .erp-confirm { display: none; padding: 16px; background: #ecfdf5; border: 1px solid #a7f3d0; border-radius: var(--radius); margin-top: 12px; }
    .erp-confirm.show { display: block; }
    .erp-confirm .customer-id { font-weight: 700; font-size: 1.1rem; color: var(--success); }

    /* Reports placeholder */
    .reports-placeholder { text-align: center; padding: 48px 24px; color: var(--text-muted); }

    /* Empty state */
    .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); font-size: 0.95rem; }

    /* Lead actions */
    .lead-actions { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px; }
    .add-note-section, .next-followup-section { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }
    .add-note-section textarea { min-height: 70px; margin-bottom: 8px; }
    .inline-form { display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; }
    .inline-form .form-group { margin-bottom: 0; flex: 1; min-width: 140px; }
    .reminders-box { background: #f0f9ff; border: 1px solid #bae6fd; border-radius: var(--radius); padding: 16px; margin-bottom: 20px; }
    .reminders-box .card-title { margin-bottom: 8px; }
    .reminders-box ul { margin: 0; padding-left: 20px; font-size: 0.9rem; color: var(--text-muted); }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sidebar-header">Steel CRM</div>
      <nav class="sidebar-nav">
        <a href="#" class="nav-link active" data-page="dashboard"><span class="icon">▣</span> Dashboard</a>
        <a href="#" class="nav-link" data-page="inbox"><span class="icon">✉</span> Lead Inbox</a>
        <a href="#" class="nav-link" data-page="create"><span class="icon">+</span> Create Lead</a>
        <a href="#" class="nav-link" data-page="table"><span class="icon">≡</span> Lead Table</a>
        <a href="#" class="nav-link" data-page="followups"><span class="icon">↻</span> Follow-ups</a>
        <a href="#" class="nav-link" data-page="converted"><span class="icon">✓</span> Converted Customers</a>
        <a href="#" class="nav-link" data-page="reports"><span class="icon">▤</span> Reports</a>
      </nav>
    </aside>
    <main class="main">
      <!-- Dashboard -->
      <div id="page-dashboard" class="page active">
        <div class="page-header"><h1>Dashboard</h1></div>
        <div class="kpi-grid">
          <div class="kpi-card"><div class="label">Total Leads</div><div class="value" id="kpi-total">124</div></div>
          <div class="kpi-card"><div class="label">Leads in Evaluation</div><div class="value" id="kpi-eval">28</div></div>
          <div class="kpi-card"><div class="label">Follow-up Leads</div><div class="value" id="kpi-followup">45</div></div>
          <div class="kpi-card"><div class="label">Converted Customers</div><div class="value" id="kpi-converted">38</div></div>
          <div class="kpi-card"><div class="label">Conversion Rate</div><div class="value" id="kpi-rate">30.6%</div></div>
          <div class="kpi-card"><div class="label">Upcoming Follow-ups</div><div class="value" id="kpi-upcoming">12</div></div>
        </div>
        <div class="card funnel-section">
          <div class="card-title">Pipeline Funnel</div>
          <div class="funnel-bar">
            <span class="stage">Lead Created</span>
            <div class="bar-wrap"><div class="bar-fill" style="width:100%;background:#3b82f6;"></div></div>
            <span class="count" id="funnel-created">124</span>
          </div>
          <div class="funnel-bar">
            <span class="stage">Matched</span>
            <div class="bar-wrap"><div class="bar-fill" id="bar-matched" style="width:58%;background:#8b5cf6;"></div></div>
            <span class="count" id="funnel-matched">72</span>
          </div>
          <div class="funnel-bar">
            <span class="stage">Follow-up</span>
            <div class="bar-wrap"><div class="bar-fill" id="bar-followup" style="width:36%;background:#0891b2;"></div></div>
            <span class="count" id="funnel-followup">45</span>
          </div>
          <div class="funnel-bar">
            <span class="stage">Converted</span>
            <div class="bar-wrap"><div class="bar-fill" id="bar-converted" style="width:31%;background:#059669;"></div></div>
            <span class="count" id="funnel-converted">38</span>
          </div>
        </div>
        <div class="card">
          <div class="ai-agents-title">AI Agents Control Center</div>
          <div class="ai-agents-grid">
            <div class="agent-card" data-agent="whatsapp">
              <div class="agent-name">WhatsApp / Email Agent</div>
              <div class="agent-desc">Sends automated outreach, follow-up messages, and email sequences to leads.</div>
              <div class="agent-meta">
                <span class="status-badge running" data-status-badge>Running</span>
                <div class="toggle-wrap">
                  <span class="toggle on" data-toggle role="button" tabindex="0" aria-label="Toggle agent"></span>
                  <span class="toggle-label">ON</span>
                </div>
              </div>
              <div class="agent-activity" data-activity>
                <div class="activity-item">Messages sent today: 23</div>
                <div class="activity-item">Emails queued: 8</div>
              </div>
            </div>
            <div class="agent-card" data-agent="qualification">
              <div class="agent-name">Lead Qualification Agent</div>
              <div class="agent-desc">Scores and qualifies leads based on requirement fit and portfolio match.</div>
              <div class="agent-meta">
                <span class="status-badge running" data-status-badge>Running</span>
                <div class="toggle-wrap">
                  <span class="toggle on" data-toggle role="button" tabindex="0" aria-label="Toggle agent"></span>
                  <span class="toggle-label">ON</span>
                </div>
              </div>
              <div class="agent-activity" data-activity>
                <div class="activity-item">Leads qualified today: 14</div>
                <div class="activity-item">Potential customers flagged: 6</div>
              </div>
            </div>
            <div class="agent-card" data-agent="personalization">
              <div class="agent-name">Personalization / Follow-Up Agent</div>
              <div class="agent-desc">Schedules follow-ups and personalizes communication based on lead behavior.</div>
              <div class="agent-meta">
                <span class="status-badge paused" data-status-badge>Paused</span>
                <div class="toggle-wrap">
                  <span class="toggle" data-toggle role="button" tabindex="0" aria-label="Toggle agent"></span>
                  <span class="toggle-label">OFF</span>
                </div>
              </div>
              <div class="agent-activity disabled" data-activity>
                <div class="activity-item">Follow-ups scheduled: 0</div>
                <div class="activity-item">Automation paused</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Lead Inbox -->
      <div id="page-inbox" class="page">
        <div class="page-header"><h1>Lead Inbox</h1></div>
        <div class="card">
          <div class="filters">
            <select id="inbox-filter-status">
              <option value="">All statuses</option>
              <option value="New">New</option>
              <option value="Evaluating">Evaluating</option>
              <option value="Matched">Matched</option>
              <option value="Follow-up">Follow-up</option>
              <option value="Converted">Converted</option>
              <option value="Closed">Closed</option>
            </select>
            <input type="text" id="inbox-search" placeholder="Search company or contact..." style="min-width:200px;">
            <button class="btn btn-secondary" id="inbox-reset">Reset</button>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Company</th>
                  <th>Contact</th>
                  <th>Source</th>
                  <th>Status</th>
                  <th>Assigned CAM</th>
                  <th>Created</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="inbox-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Create Lead -->
      <div id="page-create" class="page">
        <div class="page-header"><h1>Create Lead</h1></div>
        <div class="card">
          <form id="form-create-lead">
            <div class="form-grid">
              <div class="form-group">
                <label for="company">Company Name *</label>
                <input type="text" id="company" name="company" placeholder="e.g. ABC Steel Ltd">
                <div class="error-msg" id="err-company"></div>
                <div class="ai-prompt" id="ai-company" style="display:none;">Suggest: Ensure company name is the legal/trading name for ERP sync.</div>
              </div>
              <div class="form-group">
                <label for="contact">Contact Person *</label>
                <input type="text" id="contact" name="contact" placeholder="Full name">
                <div class="error-msg" id="err-contact"></div>
              </div>
              <div class="form-group">
                <label for="phone">Phone *</label>
                <input type="tel" id="phone" name="phone" placeholder="+91 98765 43210">
                <div class="error-msg" id="err-phone"></div>
              </div>
              <div class="form-group">
                <label for="email">Email *</label>
                <input type="email" id="email" name="email" placeholder="contact@company.com">
                <div class="error-msg" id="err-email"></div>
              </div>
              <div class="form-group">
                <label for="location">Location</label>
                <input type="text" id="location" name="location" placeholder="City, State">
              </div>
              <div class="form-group">
                <label for="source">Source</label>
                <select id="source" name="source">
                  <option value="Market Visit">Market Visit</option>
                  <option value="Referral">Referral</option>
                  <option value="Website">Website</option>
                  <option value="Trade Show">Trade Show</option>
                  <option value="Cold Call">Cold Call</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div class="form-group">
                <label for="cam">Assigned CAM</label>
                <select id="cam" name="cam">
                  <option value="John K.">John K.</option>
                  <option value="Priya M.">Priya M.</option>
                  <option value="Rahul S.">Rahul S.</option>
                  <option value="Unassigned">Unassigned</option>
                </select>
              </div>
              <div class="form-group full">
                <label for="requirement">Requirement Details *</label>
                <textarea id="requirement" name="requirement" rows="4" placeholder="Product grades, specs, quantity, delivery expectations..."></textarea>
                <div class="error-msg" id="err-requirement"></div>
                <div class="ai-prompt" id="ai-requirement" style="display:none;">Suggest: Add grade (e.g. HR/CR), thickness range, and quantity for portfolio match.</div>
              </div>
            </div>
            <div style="margin-top:20px;">
              <button type="submit" class="btn btn-primary">Create Lead</button>
              <button type="button" class="btn btn-secondary" id="form-clear">Clear</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Lead Table (same data as inbox, different view) -->
      <div id="page-table" class="page">
        <div class="page-header"><h1>Lead Table</h1></div>
        <div class="card">
          <div class="filters">
            <select id="table-filter-status">
              <option value="">All statuses</option>
              <option value="New">New</option>
              <option value="Evaluating">Evaluating</option>
              <option value="Matched">Matched</option>
              <option value="Follow-up">Follow-up</option>
              <option value="Converted">Converted</option>
              <option value="Closed">Closed</option>
            </select>
            <input type="text" id="table-search" placeholder="Search..." style="min-width:200px;">
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Company</th>
                  <th>Contact</th>
                  <th>Phone</th>
                  <th>Status</th>
                  <th>Source</th>
                  <th>CAM</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="table-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Follow-ups -->
      <div id="page-followups" class="page">
        <div class="page-header"><h1>Follow-ups</h1></div>
        <div class="reminders-box" id="followup-reminders">
          <div class="card-title">Reminders (next 7 days)</div>
          <ul id="reminders-list"></ul>
        </div>
        <div class="card">
          <div class="filters">
            <select id="followup-filter">
              <option value="">All leads</option>
            </select>
            <input type="date" id="followup-date" placeholder="Next follow-up date">
          </div>
          <div id="followup-list"></div>
        </div>
      </div>

      <!-- Converted Customers -->
      <div id="page-converted" class="page">
        <div class="page-header"><h1>Converted Customers</h1></div>
        <div class="card">
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Customer ID</th>
                  <th>Company</th>
                  <th>Contact</th>
                  <th>Converted On</th>
                  <th>CAM</th>
                </tr>
              </thead>
              <tbody id="converted-tbody"></tbody>
            </table>
          </div>
          <div class="empty-state" id="converted-empty" style="display:none;">No converted customers yet.</div>
        </div>
      </div>

      <!-- Reports -->
      <div id="page-reports" class="page">
        <div class="page-header"><h1>Reports</h1></div>
        <div class="card">
          <div class="reports-placeholder">Reports module – pipeline summary, conversion by source, and CAM performance charts can be added here.</div>
        </div>
      </div>

      <!-- Lead Detail (overlay / same main area) -->
      <div id="page-lead-detail" class="page">
        <div class="page-header">
          <button class="btn btn-secondary" id="back-from-detail" style="margin-right:12px;">← Back</button>
          <h1 style="display:inline;">Lead Detail</h1>
        </div>
        <div id="lead-detail-content"></div>
      </div>
    </main>
  </div>

  <script>
    // ----- Data (in-memory for demo) -----
    let leads = [
      { id: 1, company: 'Metro Steel Corp', contact: 'Rajesh Kumar', phone: '+91 98765 43210', email: 'rajesh@metrosteeel.com', location: 'Mumbai, MH', requirement: 'HR coils 2.0–3.0mm, 500 MT', source: 'Market Visit', cam: 'John K.', status: 'Follow-up', created: '2025-02-10', nextFollowUp: '2025-02-14', timeline: [{ date: '2025-02-10', text: 'Lead created from market visit.' }, { date: '2025-02-11', text: 'Portfolio matched. Moved to follow-up.' }, { date: '2025-02-12', text: 'Call scheduled for 14th.' }] },
      { id: 2, company: 'BuildRight Constructions', contact: 'Anita Desai', phone: '+91 91234 56789', email: 'anita@buildright.in', location: 'Pune, MH', requirement: 'TMT bars, 100 MT', source: 'Referral', cam: 'Priya M.', status: 'Evaluating', created: '2025-02-11', nextFollowUp: '', timeline: [{ date: '2025-02-11', text: 'Lead created. Awaiting portfolio check.' }] },
      { id: 3, company: 'Prime Alloys', contact: 'Vikram Singh', phone: '+91 99887 66554', email: 'vikram@primealloys.com', location: 'Ahmedabad, GJ', requirement: 'CR sheets 0.5mm', source: 'Website', cam: 'Rahul S.', status: 'New', created: '2025-02-12', nextFollowUp: '', timeline: [{ date: '2025-02-12', text: 'New lead from website form.' }] },
      { id: 4, company: 'National Fabricators', contact: 'Sneha Patel', phone: '+91 98765 11223', email: 'sneha@natfab.com', location: 'Chennai, TN', requirement: 'GP/GC sheets, 200 MT', source: 'Trade Show', cam: 'John K.', status: 'Matched', created: '2025-02-09', nextFollowUp: '2025-02-13', timeline: [{ date: '2025-02-09', text: 'Lead created.' }, { date: '2025-02-10', text: 'Portfolio matched. Potential customer.' }] },
      { id: 5, company: 'Steel World Ltd', contact: 'Amit Sharma', phone: '+91 87654 33221', email: 'amit@steelworld.com', location: 'Delhi NCR', requirement: 'HR plates 6–12mm', source: 'Referral', cam: 'Priya M.', status: 'Converted', created: '2025-02-01', customerId: 'ERP-C-1001', convertedOn: '2025-02-08', timeline: [] },
    ];
    let nextLeadId = 6;

    // ----- Navigation -----
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const page = link.getAttribute('data-page');
        if (page === 'lead-detail') return;
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        link.classList.add('active');
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        const target = document.getElementById('page-' + page);
        if (target) target.classList.add('active');
        if (page === 'dashboard') updateDashboardKpis();
        if (page === 'inbox') renderInbox();
        if (page === 'table') renderTable();
        if (page === 'followups') renderFollowups();
        if (page === 'converted') renderConverted();
      });
    });

    // ----- AI Agent toggles -----
    document.querySelectorAll('.agent-card').forEach(card => {
      const toggle = card.querySelector('[data-toggle]');
      const badge = card.querySelector('[data-status-badge]');
      const activity = card.querySelector('[data-activity]');
      const label = card.querySelector('.toggle-label');
      toggle.addEventListener('click', () => {
        const isOn = toggle.classList.toggle('on');
        if (isOn) {
          badge.textContent = 'Running';
          badge.className = 'status-badge running';
          label.textContent = 'ON';
          activity.classList.remove('disabled');
          if (card.dataset.agent === 'personalization') {
            activity.innerHTML = '<div class="activity-item">Follow-ups scheduled today: 5</div><div class="activity-item">Reminders set: 3</div>';
          }
        } else {
          badge.textContent = 'Paused';
          badge.className = 'status-badge paused';
          label.textContent = 'OFF';
          activity.classList.add('disabled');
          if (card.dataset.agent === 'personalization') {
            activity.innerHTML = '<div class="activity-item">Follow-ups scheduled: 0</div><div class="activity-item">Automation paused</div>';
          }
        }
      });
    });

    function tagClass(status) {
      const m = { New: 'tag-new', Evaluating: 'tag-evaluating', Matched: 'tag-matched', 'Follow-up': 'tag-followup', Converted: 'tag-converted', Closed: 'tag-closed' };
      return m[status] || 'tag-closed';
    }

    function filterLeads(statusFilter, search) {
      return leads.filter(l => {
        const matchStatus = !statusFilter || l.status === statusFilter;
        const matchSearch = !search || [l.company, l.contact, l.email].some(s => (s || '').toLowerCase().includes(search.toLowerCase()));
        return matchStatus && matchSearch;
      });
    }

    function renderInbox() {
      const status = document.getElementById('inbox-filter-status').value;
      const search = document.getElementById('inbox-search').value.trim();
      const rows = filterLeads(status, search);
      const tbody = document.getElementById('inbox-tbody');
      tbody.innerHTML = rows.map(l => `
        <tr>
          <td>${l.company}</td>
          <td>${l.contact}</td>
          <td>${l.source}</td>
          <td><span class="tag ${tagClass(l.status)}">${l.status}</span></td>
          <td>${l.cam}</td>
          <td>${l.created}</td>
          <td><a href="#" class="btn-link view-lead" data-id="${l.id}">View</a></td>
        </tr>
      `).join('');
      tbody.querySelectorAll('.view-lead').forEach(a => {
        a.addEventListener('click', (e) => { e.preventDefault(); openLeadDetail(a.dataset.id); });
      });
    }

    function renderTable() {
      const status = document.getElementById('table-filter-status').value;
      const search = document.getElementById('table-search').value.trim();
      const rows = filterLeads(status, search);
      const tbody = document.getElementById('table-tbody');
      tbody.innerHTML = rows.map(l => `
        <tr>
          <td>${l.company}</td>
          <td>${l.contact}</td>
          <td>${l.phone}</td>
          <td><span class="tag ${tagClass(l.status)}">${l.status}</span></td>
          <td>${l.source}</td>
          <td>${l.cam}</td>
          <td><a href="#" class="btn-link view-lead" data-id="${l.id}">View</a></td>
        </tr>
      `).join('');
      tbody.querySelectorAll('.view-lead').forEach(a => {
        a.addEventListener('click', (e) => { e.preventDefault(); openLeadDetail(a.dataset.id); });
      });
    }

    function openLeadDetail(id) {
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page-lead-detail').classList.add('active');
      renderLeadDetail(id);
    }

    document.getElementById('back-from-detail').addEventListener('click', () => {
      document.querySelector('.nav-link[data-page="inbox"]').click();
    });

    function renderLeadDetail(id) {
      const lead = leads.find(l => l.id === parseInt(id, 10));
      const container = document.getElementById('lead-detail-content');
      if (!lead) {
        container.innerHTML = '<p>Lead not found.</p>';
        return;
      }
      const steps = ['Lead Created', 'Requirement Capture', 'Portfolio Match', 'Follow-up', 'Conversion'];
      const stepIndex = lead.status === 'Converted' ? 4 : lead.status === 'Follow-up' ? 3 : lead.status === 'Matched' ? 2 : lead.status === 'Evaluating' ? 1 : 0;
      let stepsHtml = steps.map((s, i) => {
        const done = i < stepIndex;
        const current = i === stepIndex && lead.status !== 'Converted';
        return `<span class="workflow-step ${done ? 'done' : current ? 'current' : ''}"><span class="dot"></span>${s}</span>`;
      }).join('');
      let convertSection = '';
      if (lead.status === 'Follow-up' || lead.status === 'Matched') {
        convertSection = `
          <div class="convert-section">
            <button type="button" class="btn btn-success" id="btn-convert-lead" data-id="${lead.id}">Convert to Customer</button>
            <div class="erp-confirm" id="erp-confirm">
              <strong>ERP sync successful.</strong> Customer created: <span class="customer-id" id="new-customer-id"></span>
            </div>
          </div>
        `;
      } else if (lead.status === 'Converted' && lead.customerId) {
        convertSection = `<div class="convert-section"><div class="erp-confirm show">Customer ID: <span class="customer-id">${lead.customerId}</span></div></div>`;
      }
      const isEvalOrNew = lead.status === 'New' || lead.status === 'Evaluating';
      let portfolioSection = '';
      if (isEvalOrNew) {
        portfolioSection = `
          <div class="card convert-section">
            <div class="card-title">Portfolio match</div>
            <p style="font-size:0.9rem;color:var(--text-muted);margin-bottom:12px;">If requirement matches portfolio, mark as Potential Customer and move to Follow-up. Otherwise keep in Evaluation or Close.</p>
            <div class="lead-actions">
              <button type="button" class="btn btn-success" id="btn-match-portfolio" data-id="${lead.id}">Match portfolio → Follow-up</button>
              <button type="button" class="btn btn-secondary" id="btn-close-lead" data-id="${lead.id}">Close lead</button>
            </div>
          </div>
        `;
      }
      const timelineHtml = (lead.timeline || []).map(t => `<div class="timeline-item"><div class="date">${t.date}</div><div class="content">${t.text}</div></div>`).join('');
      const today = new Date().toISOString().slice(0, 10);
      container.innerHTML = `
        <div class="lead-detail-header">
          <div>
            <h1>${lead.company}</h1>
            <p style="color:var(--text-muted);margin-top:4px;">${lead.contact} · ${lead.email}</p>
          </div>
          <span class="tag ${tagClass(lead.status)}">${lead.status}</span>
        </div>
        <div class="card">
          <div class="card-title">Workflow progression</div>
          <div class="workflow-steps">${stepsHtml}</div>
        </div>
        <div class="card">
          <div class="card-title">Details</div>
          <p><strong>Phone:</strong> ${lead.phone}</p>
          <p><strong>Location:</strong> ${lead.location || '—'}</p>
          <p><strong>Requirement:</strong> ${lead.requirement || '—'}</p>
          <p><strong>Source:</strong> ${lead.source}</p>
          <p><strong>Assigned CAM:</strong> ${lead.cam}</p>
          <p><strong>Created:</strong> ${lead.created}</p>
          ${lead.nextFollowUp ? `<p><strong>Next follow-up:</strong> ${lead.nextFollowUp}</p>` : ''}
        </div>
        <div class="card">
          <div class="card-title">Interaction timeline</div>
          <div class="timeline" id="detail-timeline">${timelineHtml || '<p class="empty-state">No interactions yet.</p>'}</div>
          ${lead.status !== 'Converted' && lead.status !== 'Closed' ? `
          <div class="add-note-section">
            <label for="detail-note">Add note</label>
            <textarea id="detail-note" placeholder="Call summary, next steps..."></textarea>
            <button type="button" class="btn btn-primary" id="btn-add-note" data-id="${lead.id}">Add note</button>
          </div>
          <div class="next-followup-section">
            <label>Next follow-up date</label>
            <div class="inline-form">
              <div class="form-group">
                <input type="date" id="detail-next-followup" value="${lead.nextFollowUp || ''}" min="${today}">
              </div>
              <button type="button" class="btn btn-secondary" id="btn-set-followup" data-id="${lead.id}">Set date</button>
            </div>
          </div>
          ` : ''}
        </div>
        ${portfolioSection}
        ${convertSection}
      `;
      const btnConvert = document.getElementById('btn-convert-lead');
      if (btnConvert) {
        btnConvert.addEventListener('click', () => {
          const newId = 'ERP-C-' + String(1000 + leads.filter(l => l.customerId).length + 1);
          lead.status = 'Converted';
          lead.customerId = newId;
          lead.convertedOn = new Date().toISOString().slice(0, 10);
          document.getElementById('erp-confirm').classList.add('show');
          document.getElementById('new-customer-id').textContent = newId;
          btnConvert.remove();
          updateDashboardKpis();
          renderLeadDetail(lead.id);
        });
      }
      const btnMatch = document.getElementById('btn-match-portfolio');
      if (btnMatch) {
        btnMatch.addEventListener('click', () => {
          lead.status = 'Matched';
          lead.nextFollowUp = lead.nextFollowUp || new Date().toISOString().slice(0, 10);
          if (!lead.timeline) lead.timeline = [];
          lead.timeline.push({ date: new Date().toISOString().slice(0, 10), text: 'Portfolio matched. Marked as Potential Customer, moved to Follow-up.' });
          updateDashboardKpis();
          renderLeadDetail(lead.id);
        });
      }
      const btnClose = document.getElementById('btn-close-lead');
      if (btnClose) {
        btnClose.addEventListener('click', () => {
          lead.status = 'Closed';
          if (!lead.timeline) lead.timeline = [];
          lead.timeline.push({ date: new Date().toISOString().slice(0, 10), text: 'Lead closed (no portfolio match).' });
          updateDashboardKpis();
          renderLeadDetail(lead.id);
        });
      }
      const btnAddNote = document.getElementById('btn-add-note');
      if (btnAddNote) {
        btnAddNote.addEventListener('click', () => {
          const noteEl = document.getElementById('detail-note');
          const text = (noteEl && noteEl.value || '').trim();
          if (!text) return;
          if (!lead.timeline) lead.timeline = [];
          lead.timeline.push({ date: new Date().toISOString().slice(0, 10), text: text });
          noteEl.value = '';
          renderLeadDetail(lead.id);
        });
      }
      const btnSetFollowup = document.getElementById('btn-set-followup');
      if (btnSetFollowup) {
        btnSetFollowup.addEventListener('click', () => {
          const dateEl = document.getElementById('detail-next-followup');
          const d = (dateEl && dateEl.value) || '';
          lead.nextFollowUp = d;
          if (d && lead.timeline) {
            lead.timeline.push({ date: new Date().toISOString().slice(0, 10), text: 'Next follow-up scheduled for ' + d + '.' });
          }
          renderLeadDetail(lead.id);
        });
      }
    }

    function getNext7Days() {
      const out = [];
      for (let i = 0; i < 7; i++) {
        const d = new Date();
        d.setDate(d.getDate() + i);
        out.push(d.toISOString().slice(0, 10));
      }
      return out;
    }

    function renderFollowups() {
      const select = document.getElementById('followup-filter');
      const dateEl = document.getElementById('followup-date');
      const listEl = document.getElementById('followup-list');
      const withFollowup = leads.filter(l => l.nextFollowUp);
      const options = leads.map(l => `<option value="${l.id}">${l.company} – ${l.nextFollowUp || 'No date'}</option>`).join('');
      select.innerHTML = '<option value="">All leads</option>' + options;
      const next7 = getNext7Days();
      const reminderLeads = withFollowup.filter(l => next7.includes(l.nextFollowUp));
      const remindersListEl = document.getElementById('reminders-list');
      if (remindersListEl) {
        if (reminderLeads.length === 0) {
          remindersListEl.innerHTML = '<li>No follow-ups in the next 7 days.</li>';
        } else {
          remindersListEl.innerHTML = reminderLeads.map(l => `<li><strong>${l.nextFollowUp}</strong>: ${l.company} – <a href="#" class="btn-link view-lead-reminder" data-id="${l.id}">View</a></li>`).join('');
          remindersListEl.querySelectorAll('.view-lead-reminder').forEach(a => {
            a.addEventListener('click', (e) => { e.preventDefault(); openLeadDetail(a.dataset.id); });
          });
        }
      }
      let filtered = withFollowup;
      if (select.value) filtered = withFollowup.filter(l => l.id === parseInt(select.value, 10));
      if (dateEl.value) filtered = filtered.filter(l => l.nextFollowUp === dateEl.value);
      if (filtered.length === 0) {
        listEl.innerHTML = '<div class="empty-state">No upcoming follow-ups match the filter.</div>';
      } else {
        listEl.innerHTML = filtered.map(l => {
          const lastNote = (l.timeline && l.timeline.length) ? l.timeline[l.timeline.length - 1].text : '—';
          return `
          <div class="card" style="margin-bottom:12px;">
            <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;">
              <div>
                <strong>${l.company}</strong> – ${l.contact}<br>
                <span style="font-size:0.85rem;color:var(--text-muted);">Next follow-up: ${l.nextFollowUp}</span>
                ${lastNote !== '—' ? '<br><span style="font-size:0.8rem;color:var(--text-muted);">Last note: ' + lastNote.slice(0, 60) + (lastNote.length > 60 ? '…' : '') + '</span>' : ''}
              </div>
              <a href="#" class="btn-link view-lead" data-id="${l.id}">View lead</a>
            </div>
          </div>
        `;
        }).join('');
        listEl.querySelectorAll('.view-lead').forEach(a => {
          a.addEventListener('click', (e) => { e.preventDefault(); openLeadDetail(a.dataset.id); });
        });
      }
    }

    function renderConverted() {
      const converted = leads.filter(l => l.status === 'Converted');
      const tbody = document.getElementById('converted-tbody');
      const empty = document.getElementById('converted-empty');
      if (converted.length === 0) {
        tbody.innerHTML = '';
        empty.style.display = 'block';
      } else {
        empty.style.display = 'none';
        tbody.innerHTML = converted.map(l => `
          <tr>
            <td>${l.customerId || '—'}</td>
            <td>${l.company}</td>
            <td>${l.contact}</td>
            <td>${l.convertedOn || '—'}</td>
            <td>${l.cam}</td>
          </tr>
        `).join('');
      }
    }

    document.getElementById('inbox-filter-status').addEventListener('change', renderInbox);
    document.getElementById('inbox-search').addEventListener('input', renderInbox);
    document.getElementById('inbox-reset').addEventListener('click', () => {
      document.getElementById('inbox-filter-status').value = '';
      document.getElementById('inbox-search').value = '';
      renderInbox();
    });
    document.getElementById('table-filter-status').addEventListener('change', renderTable);
    document.getElementById('table-search').addEventListener('input', renderTable);
    document.getElementById('followup-filter').addEventListener('change', renderFollowups);
    document.getElementById('followup-date').addEventListener('change', renderFollowups);

    // ----- Create Lead form -----
    const form = document.getElementById('form-create-lead');
    const required = ['company', 'contact', 'phone', 'email', 'requirement'];
    const aiPrompts = { company: 'ai-company', requirement: 'ai-requirement' };

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      let valid = true;
      required.forEach(field => {
        const el = document.getElementById(field);
        const err = document.getElementById('err-' + field);
        const ai = document.getElementById(aiPrompts[field]);
        const v = (el && el.value) ? el.value.trim() : '';
        if (!v) {
          valid = false;
          if (el) el.classList.add('error');
          if (err) err.textContent = 'This field is required.';
          if (ai) ai.style.display = 'block';
        } else {
          if (el) el.classList.remove('error');
          if (err) err.textContent = '';
          if (ai) ai.style.display = 'none';
        }
      });
      if (!valid) return;
      const newLead = {
        id: nextLeadId++,
        company: document.getElementById('company').value.trim(),
        contact: document.getElementById('contact').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        email: document.getElementById('email').value.trim(),
        location: document.getElementById('location').value.trim(),
        requirement: document.getElementById('requirement').value.trim(),
        source: document.getElementById('source').value,
        cam: document.getElementById('cam').value,
        status: 'New',
        created: new Date().toISOString().slice(0, 10),
        nextFollowUp: '',
        timeline: [{ date: new Date().toISOString().slice(0, 10), text: 'Lead created from ' + document.getElementById('source').value + '.' }]
      };
      leads.push(newLead);
      form.reset();
      required.forEach(f => {
        const err = document.getElementById('err-' + f);
        const ai = document.getElementById(aiPrompts[f]);
        if (err) err.textContent = '';
        if (ai) ai.style.display = 'none';
        const el = document.getElementById(f);
        if (el) el.classList.remove('error');
      });
      updateDashboardKpis();
      document.querySelector('.nav-link[data-page="inbox"]').click();
      renderInbox();
    });

    document.getElementById('form-clear').addEventListener('click', () => {
      form.reset();
      required.forEach(f => {
        document.getElementById('err-' + f).textContent = '';
        const ai = document.getElementById(aiPrompts[f]);
        if (ai) ai.style.display = 'none';
        document.getElementById(f).classList.remove('error');
      });
    });

    // Blur validation + AI prompt for optional but important fields
    ['company', 'requirement'].forEach(field => {
      const el = document.getElementById(field);
      if (el) el.addEventListener('blur', () => {
        const v = el.value.trim();
        const err = document.getElementById('err-' + field);
        const ai = document.getElementById(aiPrompts[field]);
        if (!v && required.includes(field)) {
          if (err) err.textContent = 'This field is required.';
          if (ai) ai.style.display = 'block';
        } else if (v && ai) ai.style.display = 'none';
      });
    });

    // ----- Initial render -----
    function updateDashboardKpis() {
      const total = leads.length;
      const eval_ = leads.filter(l => l.status === 'Evaluating' || l.status === 'New').length;
      const followup = leads.filter(l => l.status === 'Follow-up').length;
      const converted = leads.filter(l => l.status === 'Converted').length;
      const matched = leads.filter(l => ['Matched', 'Follow-up', 'Converted'].includes(l.status)).length;
      const rate = total ? ((converted / total) * 100).toFixed(1) : 0;
      const upcoming = leads.filter(l => l.nextFollowUp).length;
      document.getElementById('kpi-total').textContent = total;
      document.getElementById('kpi-eval').textContent = eval_;
      document.getElementById('kpi-followup').textContent = followup;
      document.getElementById('kpi-converted').textContent = converted;
      document.getElementById('kpi-rate').textContent = rate + '%';
      document.getElementById('kpi-upcoming').textContent = upcoming;
      document.getElementById('funnel-created').textContent = total;
      document.getElementById('funnel-matched').textContent = matched;
      document.getElementById('funnel-followup').textContent = followup;
      document.getElementById('funnel-converted').textContent = converted;
      const pct = (n) => total ? Math.round((n / total) * 100) : 0;
      const barMatched = document.getElementById('bar-matched');
      const barFollowup = document.getElementById('bar-followup');
      const barConverted = document.getElementById('bar-converted');
      if (barMatched) barMatched.style.width = pct(matched) + '%';
      if (barFollowup) barFollowup.style.width = pct(followup) + '%';
      if (barConverted) barConverted.style.width = pct(converted) + '%';
    }
    updateDashboardKpis();
    renderInbox();
    renderTable();
    renderFollowups();
    renderConverted();
  </script>
</body>
</html>
